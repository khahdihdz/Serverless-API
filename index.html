<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hack Fit</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f4f7fa;
        }
        .container {
            margin-top: 50px;
        }
        #status {
            margin-top: 20px;
        }
        .input-group {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center">Hack Fit - Google Fit Step Counter</h1>
        <div class="row">
            <div class="col-md-6 offset-md-3">
                <button id="loginBtn" class="btn btn-primary btn-block" onclick="loginGoogleFit()">Đăng nhập Google</button>
                <p id="status" class="text-center"></p>
                <div class="input-group">
                    <input type="number" class="form-control" id="stepCount" placeholder="Nhập số bước chân" />
                    <button class="btn btn-success" onclick="sendSteps()">Gửi bước chân</button>
                </div>
                <button class="btn btn-warning btn-block" onclick="checkData()">Kiểm tra dữ liệu</button>
            </div>
        </div>
    </div>

    <script>
        let accessToken = null; // Token truy cập từ Google OAuth

        // Hàm đăng nhập Google
        function loginGoogleFit() {
            const clientId = "422012132533-pgroo786kqrbdq8aj1b791erm4aic29l.apps.googleusercontent.com";  // Thay thế bằng Client ID của bạn
            const redirectUri = "https://hackfit-beta.vercel.app";  // URL redirect của bạn
            const scope = "https://www.googleapis.com/auth/fitness.activity.write";

            const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?response_type=token&client_id=${clientId}&redirect_uri=${redirectUri}&scope=${encodeURIComponent(scope)}&state=123`;

            window.location.href = authUrl;
        }

        // Xử lý lấy token từ URL
        window.onload = function () {
            const hash = window.location.hash.substring(1); // Lấy phần hash của URL
            const params = new URLSearchParams(hash);

            // Lấy token từ URL
            if (params.has("access_token")) {
                accessToken = params.get("access_token");
                console.log("Đăng nhập thành công!");
                document.getElementById("status").innerText = "✅ Đăng nhập thành công!";
                window.history.pushState({}, "", "/"); // Dọn dẹp URL sau khi lấy token
            } else if (params.has("error")) {
                document.getElementById("status").innerText = "❌ Lỗi đăng nhập: " + params.get("error_description");
            } else {
                document.getElementById("status").innerText = "⚠️ Đăng nhập không thành công!";
            }
        };

        // Gửi dữ liệu số bước chân vào Google Fit API
        function sendSteps() {
            if (!accessToken) {
                document.getElementById("status").innerText = "⚠️ Vui lòng đăng nhập trước!";
                return;
            }

            const stepCount = document.getElementById("stepCount").value;

            if (!stepCount) {
                document.getElementById("status").innerText = "⚠️ Vui lòng nhập số bước chân!";
                return;
            }

            const apiUrl = "https://www.googleapis.com/fitness/v1/users/me/dataset:insert";
            const data = {
                "dataSourceId": "derived:com.google.step_count.delta:com.google.android.gms:estimated_steps",
                "maxEndTimeNs": (new Date()).getTime() * 1000000, // Thời gian hiện tại (Nano giây)
                "minStartTimeNs": (new Date()).getTime() * 1000000 - 10000000000, // Thời gian 10 giây trước
                "point": [{
                    "startTimeNanos": (new Date()).getTime() * 1000000 - 10000000000,
                    "endTimeNanos": (new Date()).getTime() * 1000000,
                    "value": [{
                        "intVal": parseInt(stepCount)
                    }]
                }]
            };

            fetch(apiUrl, {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${accessToken}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                console.log(data);
                if (data.error) {
                    document.getElementById("status").innerText = `❌ Lỗi: ${data.error.message}`;
                } else {
                    document.getElementById("status").innerText = "✅ Đã ghi dữ liệu bước chân thành công!";
                }
            })
            .catch(error => {
                console.error("Có lỗi xảy ra:", error);
                document.getElementById("status").innerText = "❌ Lỗi kết nối!";
            });
        }

        // Kiểm tra dữ liệu đã ghi vào Google Fit hay chưa
        function checkData() {
            if (!accessToken) {
                document.getElementById("status").innerText = "⚠️ Vui lòng đăng nhập trước!";
                return;
            }

            const apiUrl = "https://www.googleapis.com/fitness/v1/users/me/dataset:aggregate";
            const data = {
                "aggregateBy": [{
                    "dataSourceId": "derived:com.google.step_count.delta:com.google.android.gms:estimated_steps"
                }],
                "bucketByTime": {
                    "durationMillis": 86400000 // 1 ngày
                },
                "startTimeMillis": (new Date()).getTime() - 86400000, // 24 giờ trước
                "endTimeMillis": new Date().getTime() // Thời gian hiện tại
            };

            fetch(apiUrl, {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${accessToken}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.bucket && data.bucket.length > 0) {
                    const steps = data.bucket[0].dataset[0].point.reduce((total, point) => total + point.value[0].intVal, 0);
                    document.getElementById("status").innerText = `✅ Dữ liệu bước chân: ${steps} bước`;
                } else {
                    document.getElementById("status").innerText = "❌ Không có dữ liệu bước chân trong 24 giờ qua!";
                }
            })
            .catch(error => {
                console.error("Có lỗi xảy ra:", error);
                document.getElementById("status").innerText = "❌ Lỗi kết nối!";
            });
        }
    </script>
</body>
</html>