<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Fit - Ghi Số Bước Chân</title>
    <!-- Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="container mt-5">
        <div class="text-center">
            <h1 class="text-primary">Google Fit - Ghi Số Bước Chân</h1>
            <p class="lead text-muted">Đăng nhập và ghi lại số bước chân của bạn vào Google Fit</p>
        </div>

        <!-- Thông báo tác vụ -->
        <div id="task_message" class="alert alert-info" role="alert" style="display:none;"></div>

        <!-- Nút đăng nhập -->
        <div class="text-center">
            <button id="authorize_button" class="btn btn-success mb-3">Đăng Nhập</button>
            <button id="signout_button" class="btn btn-danger mb-3" style="display: none;">Đăng Xuất</button>
        </div>

        <!-- Ghi số bước chân -->
        <div class="form-group">
            <label for="steps_input">Nhập số bước chân bạn muốn ghi:</label>
            <input type="number" id="steps_input" class="form-control" placeholder="Nhập số bước chân" />
        </div>
        
        <div class="text-center">
            <button id="record_steps_button" class="btn btn-primary">Ghi Số Bước Chân</button>
        </div>
    </div>

    <!-- Bootstrap JS và các phụ thuộc -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script>
        var clientId = '422012132533-pgroo786kqrbdq8aj1b791erm4aic29l.apps.googleusercontent.com'; // Thay bằng client ID của bạn
        var apiKey = 'AIzaSyCDAqPtdamfREUzrgK5f01mUPodtn-8ojY'; // Thay bằng API Key của bạn
        var scopes = 'https://www.googleapis.com/auth/fitness.activity.write';

        var gapiLoaded = false;

        // Hàm load API
        function loadGAPI() {
            gapi.load('client:auth2', initAuth);
        }

        // Hàm khởi tạo xác thực
        function initAuth() {
            gapi.auth2.init({
                client_id: clientId
            }).then(function () {
                document.getElementById('authorize_button').style.display = 'block';
                document.getElementById('signout_button').style.display = 'none';
                showTaskMessage('Bạn đã đăng nhập thành công!', 'success');
            });
        }

        // Hàm đăng nhập
        function handleAuthClick(event) {
            gapi.auth2.getAuthInstance().signIn().then(function () {
                document.getElementById('authorize_button').style.display = 'none';
                document.getElementById('signout_button').style.display = 'block';
                showTaskMessage('Bạn đã đăng nhập thành công!', 'success');
            }).catch(function(error) {
                showTaskMessage('Lỗi khi đăng nhập: ' + error.error, 'danger');
            });
        }

        // Hàm ghi số bước chân vào Google Fit
        function recordSteps(steps) {
            var datasetId = '0-' + Date.now();
            var request = gapi.client.fitness.users.dataSources.datasets.update({
                'userId': 'me',
                'dataSourceId': 'derived:com.google.step_count.delta:com.google.android.gms:merge_step_deltas',
                'datasetId': datasetId,
                'body': {
                    'point': [{
                        'startTimeNanos': Date.now() - (60 * 1000000000), // 1 hour ago
                        'endTimeNanos': Date.now(),
                        'value': [{ 'intVal': steps }]
                    }]
                }
            });

            request.execute(function (response) {
                if (response.error) {
                    showTaskMessage('Lỗi khi ghi số bước chân: ' + response.error.message, 'danger');
                } else {
                    showTaskMessage('Đã ghi số bước chân thành công!', 'success');
                }
            });
        }

        // Hàm hiển thị thông báo tác vụ
        function showTaskMessage(message, type) {
            var taskMessageElement = document.getElementById('task_message');
            taskMessageElement.style.display = 'block';
            taskMessageElement.textContent = message;
            taskMessageElement.className = 'alert alert-' + type;
        }

        // Đăng ký sự kiện
        document.getElementById('authorize_button').addEventListener('click', handleAuthClick);
        document.getElementById('signout_button').addEventListener('click', function () {
            gapi.auth2.getAuthInstance().signOut();
            document.getElementById('authorize_button').style.display = 'block';
            document.getElementById('signout_button').style.display = 'none';
            showTaskMessage('Bạn đã đăng xuất.', 'info');
        });

        document.getElementById('record_steps_button').addEventListener('click', function () {
            var steps = document.getElementById('steps_input').value;
            if (steps && !isNaN(steps)) {
                showTaskMessage('Đang ghi số bước chân...', 'info');
                recordSteps(Number(steps));
            } else {
                showTaskMessage("Vui lòng nhập số bước chân hợp lệ.", 'danger');
            }
        });

        // Khởi tạo API khi trang web được tải
        loadGAPI();
    </script>
</body>
</html>