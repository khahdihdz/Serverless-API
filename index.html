<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hack Fit</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body {
            background-color: #f0f8ff;
            color: #333;
        }
        .container {
            max-width: 600px;
            margin-top: 50px;
        }
        .alert {
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4">Hack Fit - Nhập Số Bước Chân</h1>
        <div id="status" class="alert alert-info text-center">
            Vui lòng đăng nhập vào tài khoản Google Fit.
        </div>
        <button class="btn btn-primary btn-block" id="loginBtn">Đăng nhập Google</button>
        <div class="form-group mt-4">
            <label for="stepsInput">Nhập số bước chân:</label>
            <input type="number" id="stepsInput" class="form-control" placeholder="Ví dụ: 10000">
        </div>
        <button class="btn btn-success btn-block" id="submitBtn" disabled>Ghi Số Bước Chân</button>
    </div>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
    <script>
        let accessToken = null;

        function loadClient() {
            gapi.client.setApiKey("AIzaSyCDAqPtdamfREUzrgK5f01mUPodtn-8ojY"); // Thay YOUR_API_KEY bằng API Key của bạn
            return gapi.client.load("https://content.googleapis.com/discovery/v1/apis/fitness/v1/rest")
                .then(() => {
                    console.log("Google Fit API loaded successfully.");
                }, (err) => {
                    console.error("Error loading Google Fit API", err);
                });
        }

        function authenticate() {
            return gapi.auth2.getAuthInstance().signIn({ scope: "https://www.googleapis.com/auth/fitness.activity.write https://www.googleapis.com/auth/fitness.activity.read" })
                .then((response) => {
                    accessToken = response.getAuthResponse().access_token;
                    console.log("Đăng nhập thành công với Access Token:", accessToken);
                    document.getElementById("status").innerText = "Đã đăng nhập thành công!";
                    document.getElementById("submitBtn").disabled = false;
                }, (err) => {
                    console.error("Lỗi đăng nhập:", err);
                    document.getElementById("status").innerText = "Lỗi đăng nhập!";
                    alert("Đăng nhập không thành công. Vui lòng thử lại!");
                });
        }

        function fakeSteps() {
            if (!accessToken) {
                alert("Vui lòng đăng nhập trước!");
                return;
            }

            const steps = parseInt(document.getElementById("stepsInput").value) || 10000;
            const currentTimeMillis = Date.now();
            const startTimeMillis = currentTimeMillis - 3600000; // Lùi lại 1 giờ

            const requestBody = {
                "name": "session_hack_" + Date.now(),
                "description": "Fake bước chân",
                "startTimeMillis": startTimeMillis,
                "endTimeMillis": currentTimeMillis,
                "activityType": 8,  // Walking
                "application": {
                    "packageName": "com.example.hackfit"
                },
                "dataSets": [{
                    "dataSourceId": "derived:com.google.step_count.delta:com.google.android.gms:estimated_steps",
                    "point": [{
                        "startTimeNanos": startTimeMillis * 1e6,
                        "endTimeNanos": currentTimeMillis * 1e6,
                        "dataTypeName": "com.google.step_count.delta",
                        "value": [{ "intVal": steps }]
                    }]
                }]
            };

            fetch("https://www.googleapis.com/fitness/v1/users/me/sessions", {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${accessToken}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(requestBody)
            })
            .then(response => response.json())
            .then(data => {
                console.log("Ghi bước chân:", data);
                document.getElementById("status").innerText = "✅ Ghi bước chân thành công!";
            })
            .catch(error => {
                console.error("Lỗi ghi dữ liệu:", error);
                document.getElementById("status").innerText = "❌ Lỗi ghi dữ liệu!";
            });
        }

        document.getElementById("loginBtn").addEventListener("click", () => {
            gapi.load("client:auth2", () => {
                gapi.auth2.init({
                    client_id: "422012132533-pgroo786kqrbdq8aj1b791erm4aic29l.apps.googleusercontent.com", // Thay YOUR_CLIENT_ID bằng Client ID của bạn
                }).then(() => {
                    authenticate();
                }).catch((err) => {
                    console.error("Lỗi khởi tạo auth2:", err);
                    alert("Lỗi khởi tạo đăng nhập, vui lòng thử lại!");
                });
            });
        });

        document.getElementById("submitBtn").addEventListener("click", () => {
            fakeSteps();
        });
    </script>
</body>
</html>