<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Fit - Quản lý Bước Chân</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .container {
            background: #ffffff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
        }
        .btn-custom {
            width: 100%;
            font-size: 18px;
        }
    </style>
</head>
<body>

<div class="container text-center">
    <h1 class="mb-3">Google Fit - Quản lý Bước Chân</h1>
    <button id="loginButton" class="btn btn-primary btn-custom">Đăng nhập Google</button>
    <div id="controlPanel" class="mt-3" style="display: none;">
        <input type="number" id="stepInput" class="form-control mb-2" placeholder="Nhập số bước chân">
        <button id="writeButton" class="btn btn-success btn-custom mb-2">Ghi Dữ Liệu</button>
        <button id="readButton" class="btn btn-info btn-custom">Đọc Dữ Liệu</button>
    </div>
    <div id="stepData" class="mt-3"></div>
</div>

<script>
    const CLIENT_ID = '422012132533-pgroo786kqrbdq8aj1b791erm4aic29l.apps.googleusercontent.com'; // Thay bằng Client ID của bạn
    const API_KEY = 'AIzaSyCDAqPtdamfREUzrgK5f01mUPodtn-8ojY'; // Thay bằng API Key của bạn
    const SCOPES = 'https://www.googleapis.com/auth/fitness.activity.write https://www.googleapis.com/auth/fitness.activity.read';

    let accessToken;

    function loadClient() {
        gapi.client.setApiKey(API_KEY);
        return gapi.client.load("https://content.googleapis.com/discovery/v1/apis/fitness/v1/rest");
    }

    function handleAuthClick() {
        gapi.auth2.getAuthInstance().signIn({ scope: SCOPES }).then(function() {
            accessToken = gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().access_token;
            document.getElementById('loginButton').style.display = 'none';
            document.getElementById('controlPanel').style.display = 'block';
        });
    }

    function writeStepData() {
        const stepCount = document.getElementById('stepInput').value || 1000;
        const apiUrl = "https://www.googleapis.com/fitness/v1/users/me/dataset:insert";
        const timestamp = (new Date()).getTime() * 1000000;

        const data = {
            "dataSourceId": "derived:com.google.step_count.delta:com.google.android.gms:estimated_steps",
            "maxEndTimeNs": timestamp,
            "minStartTimeNs": timestamp - 10000000000,
            "point": [{
                "startTimeNanos": timestamp - 10000000000,
                "endTimeNanos": timestamp,
                "value": [{"intVal": parseInt(stepCount)}]
            }]
        };

        fetch(apiUrl, {
            method: "POST",
            headers: {
                "Authorization": `Bearer ${accessToken}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify(data)
        }).then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert("Lỗi khi ghi dữ liệu: " + data.error.message);
                } else {
                    alert("Dữ liệu đã được ghi thành công!");
                }
            }).catch(error => {
                alert("Có lỗi xảy ra: " + error);
            });
    }

    function readStepData() {
        const readUrl = "https://www.googleapis.com/fitness/v1/users/me/dataset:aggregate";
        const readData = {
            "aggregateBy": [{
                "dataTypeName": "com.google.step_count.delta",
                "dataSourceId": "derived:com.google.step_count.delta:com.google.android.gms:estimated_steps"
            }],
            "startTimeMillis": (new Date()).getTime() - 86400000,
            "endTimeMillis": new Date().getTime()
        };

        fetch(readUrl, {
            method: "POST",
            headers: {
                "Authorization": `Bearer ${accessToken}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify(readData)
        }).then(response => response.json())
            .then(data => {
                let stepCount = 0;
                if (data.bucket && data.bucket.length > 0) {
                    stepCount = data.bucket[0].dataset[0].point.reduce((sum, point) => sum + point.value[0].intVal, 0);
                }
                document.getElementById('stepData').innerHTML = `
                    <div class="alert alert-info">Tổng số bước chân trong 24h qua: <b>${stepCount}</b></div>
                `;
            }).catch(error => {
                alert("Có lỗi xảy ra khi đọc dữ liệu: " + error);
            });
    }

    function start() {
        gapi.load("client:auth2", function() {
            gapi.auth2.init({ client_id: CLIENT_ID }).then(function() {
                document.getElementById('loginButton').addEventListener('click', handleAuthClick);
                document.getElementById('writeButton').addEventListener('click', writeStepData);
                document.getElementById('readButton').addEventListener('click', readStepData);
            });
        });
    }

    window.onload = start;
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>