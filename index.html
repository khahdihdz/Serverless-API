<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Theo dõi bước chân Google Fit</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <nav class="navbar navbar-dark bg-primary">
        <div class="container">
            <span class="navbar-brand mb-0 h1">Theo dõi bước chân Google Fit</span>
            <button id="authorize_button" class="btn btn-light">Đăng nhập</button>
            <button id="signout_button" class="btn btn-light d-none">Đăng xuất</button>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Số bước chân hôm nay</h5>
                    </div>
                    <div class="card-body">
                        <h2 id="steps-today">--</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Thêm bước chân mới</h5>
                    </div>
                    <div class="card-body">
                        <form id="add-steps-form">
                            <div class="mb-3">
                                <label for="steps" class="form-label">Số bước</label>
                                <input type="number" class="form-control" id="steps" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Lưu</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Lịch sử bước chân</h5>
                    </div>
                    <div class="card-body">
                        <div id="steps-history"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Client ID từ Google Cloud Console
        const CLIENT_ID = '422012132533-pgroo786kqrbdq8aj1b791erm4aic29l.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyCDAqPtdamfREUzrgK5f01mUPodtn-8ojY';
        
        // Google Fit API scopes
        const SCOPES = 'https://www.googleapis.com/auth/fitness.activity.read https://www.googleapis.com/auth/fitness.activity.write';
        
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;

        // Khởi tạo GAPI
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/fitness/v1/rest'],
            });
            gapiInited = true;
            maybeEnableButtons();
        }

        // Khởi tạo Google Identity Services
        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '', // Được định nghĩa sau
            });
            gisInited = true;
            maybeEnableButtons();
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                document.getElementById('authorize_button').style.display = 'block';
            }
        }

        // Xử lý đăng nhập
        function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    throw (resp);
                }
                document.getElementById('authorize_button').classList.add('d-none');
                document.getElementById('signout_button').classList.remove('d-none');
                await loadStepsData();
            };

            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        // Xử lý đăng xuất
        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
                document.getElementById('authorize_button').classList.remove('d-none');
                document.getElementById('signout_button').classList.add('d-none');
                document.getElementById('steps-today').innerText = '--';
                document.getElementById('steps-history').innerHTML = '';
            }
        }

        // Đọc dữ liệu bước chân
        async function loadStepsData() {
            try {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);

                const request = {
                    aggregateBy: [{
                        dataTypeName: 'com.google.step_count.delta',
                    }],
                    bucketByTime: { durationMillis: 86400000 },
                    startTimeMillis: today.getTime(),
                    endTimeMillis: tomorrow.getTime(),
                };

                const response = await gapi.client.fitness.users.dataset.aggregate({
                    userId: 'me',
                    resource: request
                });

                const steps = response.result.bucket[0].dataset[0].point[0]?.value[0]?.intVal || 0;
                document.getElementById('steps-today').innerText = steps;

            } catch (err) {
                console.error('Error loading steps data:', err);
            }
        }

        // Ghi dữ liệu bước chân
        async function insertSteps(stepCount) {
            const dataSet = {
                dataSourceId: 'raw:com.google.step_count.delta:app_name:web_app',
                point: [{
                    startTimeNanos: Date.now() * 1000000,
                    endTimeNanos: (Date.now() * 1000000) + 1,
                    value: [{
                        intVal: stepCount
                    }]
                }]
            };

            try {
                await gapi.client.fitness.users.dataSources.datasets.patch({
                    userId: 'me',
                    dataSourceId: dataSet.dataSourceId,
                    datasetId: `${dataSet.point[0].startTimeNanos}-${dataSet.point[0].endTimeNanos}`,
                    resource: dataSet
                });

                await loadStepsData();
            } catch (err) {
                console.error('Error inserting steps:', err);
            }
        }

        // Event listeners
        document.getElementById('authorize_button').addEventListener('click', handleAuthClick);
        document.getElementById('signout_button').addEventListener('click', handleSignoutClick);
        document.getElementById('add-steps-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const steps = parseInt(document.getElementById('steps').value);
            await insertSteps(steps);
            document.getElementById('steps').value = '';
        });
    </script>

    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>