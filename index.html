<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Fit API - Đọc và Ghi Dữ Liệu</title>
    <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>
    <h1>Google Fit - Đọc và Ghi Dữ Liệu Bước Chân</h1>
    <button id="loginButton">Đăng nhập Google</button>
    <button id="writeButton" style="display:none;">Ghi Dữ Liệu</button>
    <button id="readButton" style="display:none;">Đọc Dữ Liệu</button>

    <div id="stepData"></div>

    <script>
        const CLIENT_ID = 'YOUR_CLIENT_ID'; // Thay bằng Client ID của bạn
        const API_KEY = 'YOUR_API_KEY'; // Thay bằng API Key của bạn
        const SCOPES = 'https://www.googleapis.com/auth/fitness.activity.write https://www.googleapis.com/auth/fitness.activity.read';

        let accessToken;

        // Tải API Google
        function loadClient() {
            gapi.client.setApiKey(API_KEY);
            return gapi.client.load("https://content.googleapis.com/discovery/v1/apis/fitness/v1/rest");
        }

        // Đăng nhập và xác thực
        function handleAuthClick(event) {
            gapi.auth2.getAuthInstance().signIn({
                scope: SCOPES
            }).then(function() {
                console.log('Đăng nhập thành công');
                accessToken = gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().access_token;
                document.getElementById('loginButton').style.display = 'none';
                document.getElementById('writeButton').style.display = 'inline';
                document.getElementById('readButton').style.display = 'inline';
            });
        }

        // Ghi dữ liệu bước chân
        function writeStepData() {
            const stepCount = 1000; // Số bước chân mẫu

            const apiUrl = "https://www.googleapis.com/fitness/v1/users/me/dataset:insert";
            const data = {
                "dataSourceId": "derived:com.google.step_count.delta:com.google.android.gms:estimated_steps",
                "maxEndTimeNs": (new Date()).getTime() * 1000000,
                "minStartTimeNs": (new Date()).getTime() * 1000000 - 10000000000,
                "point": [{
                    "startTimeNanos": (new Date()).getTime() * 1000000 - 10000000000,
                    "endTimeNanos": (new Date()).getTime() * 1000000,
                    "value": [{
                        "intVal": parseInt(stepCount)
                    }]
                }]
            };

            fetch(apiUrl, {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${accessToken}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(data)
            }).then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.log("Lỗi khi ghi dữ liệu: ", data.error.message);
                    } else {
                        console.log("Dữ liệu đã được ghi thành công.");
                        alert('Dữ liệu đã được ghi thành công!');
                    }
                }).catch(error => {
                    console.log("Có lỗi xảy ra khi ghi dữ liệu: ", error);
                });
        }

        // Đọc dữ liệu bước chân
        function readStepData() {
            const readUrl = "https://www.googleapis.com/fitness/v1/users/me/dataset:aggregate";
            const readData = {
                "aggregateBy": [{
                    "dataTypeName": "com.google.step_count.delta",
                    "dataSourceId": "derived:com.google.step_count.delta:com.google.android.gms:estimated_steps"
                }],
                "startTimeMillis": (new Date()).getTime() - 86400000, // 24 giờ trước
                "endTimeMillis": new Date().getTime() // Thời gian hiện tại
            };

            fetch(readUrl, {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${accessToken}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(readData)
            }).then(response => response.json())
                .then(data => {
                    console.log("Dữ liệu bước chân đọc được: ", data);
                    if (data.bucket && data.bucket.length > 0) {
                        const stepCount = data.bucket[0].dataset[0].point.reduce((sum, point) => sum + point.value[0].intVal, 0);
                        document.getElementById('stepData').innerText = `Tổng số bước chân trong 24 giờ qua: ${stepCount}`;
                    } else {
                        document.getElementById('stepData').innerText = "Không có dữ liệu bước chân.";
                    }
                }).catch(error => {
                    console.log("Có lỗi xảy ra khi đọc dữ liệu: ", error);
                });
        }

        // Tải và khởi tạo ứng dụng
        function start() {
            gapi.load("client:auth2", function() {
                gapi.auth2.init({
                    client_id: CLIENT_ID
                }).then(function() {
                    document.getElementById('loginButton').addEventListener('click', handleAuthClick);
                    document.getElementById('writeButton').addEventListener('click', writeStepData);
                    document.getElementById('readButton').addEventListener('click', readStepData);
                });
            });
        }

        // Khởi động ứng dụng khi tải trang
        window.onload = start;
    </script>
</body>
</html>