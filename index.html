<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Tạo AI Video Quảng Cáo từ Link Sản Phẩm</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; background: #f9f9f9; }
    input, button { padding: 10px; font-size: 16px; margin: 10px; }
    img, video { max-width: 100%; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>Tạo AI Video Quảng Cáo từ Link Sản Phẩm</h1>
  <p>Nhập URL sản phẩm để tạo video:</p>
  <input type="text" id="productUrl" placeholder="Nhập link sản phẩm">
  <button onclick="fetchProductImage()">Lấy Ảnh & Tạo Video</button>
  <div id="output"></div>

  <script>
    async function fetchProductImage() {
      const productUrl = document.getElementById("productUrl").value.trim();
      if (!productUrl) {
        alert("Vui lòng nhập link sản phẩm hợp lệ!");
        return;
      }

      document.getElementById("output").innerHTML = "<p>Đang lấy ảnh sản phẩm...</p>";

      try {
        // Gửi request đến server để lấy ảnh (bạn cần tạo API backend nếu CORS bị chặn)
        const response = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(productUrl)}`);
        const data = await response.json();
        
        const parser = new DOMParser();
        const doc = parser.parseFromString(data.contents, "text/html");
        const imageElement = doc.querySelector("img"); // Lấy ảnh đầu tiên
        const imageUrl = imageElement ? imageElement.src : null;

        if (!imageUrl) {
          document.getElementById("output").innerHTML = "<p>Không tìm thấy ảnh sản phẩm.</p>";
          return;
        }

        document.getElementById("output").innerHTML = `<p>Ảnh sản phẩm:</p><img src="${imageUrl}" width="300">`;

        generateVideo(imageUrl);
      } catch (error) {
        console.error("Lỗi khi lấy ảnh sản phẩm:", error);
        document.getElementById("output").innerHTML = "<p>Lỗi khi lấy ảnh.</p>";
      }
    }

    async function generateVideo(imageUrl) {
      const apiUrl = "https://api.runwayml.com/v1/image_to_video";
      const payload = {
        image_url: imageUrl,
        duration: 10,
        effect: "cinematic"
      };

      try {
        document.getElementById("output").innerHTML += "<p>Đang tạo video...</p>";

        const response = await fetch(apiUrl, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer key_90dc8799861e15d5eb35a1e204ddd76ebb792992290f6769074ae43b5886b9166eb25213d77a8f95e1ab897ce1c29f328a5e16eacf63547ba9baf1bb2fd52cfd"
          },
          body: JSON.stringify(payload)
        });

        if (!response.ok) throw new Error("Lỗi API: " + response.status);
        const data = await response.json();
        const videoUrl = data.video_url;

        if (videoUrl) {
          document.getElementById("output").innerHTML = `
            <h2>Video Quảng Cáo:</h2>
            <video controls autoplay>
              <source src="${videoUrl}" type="video/mp4">
              Trình duyệt không hỗ trợ video.
            </video>
          `;
          animateOverlay();
        } else {
          document.getElementById("output").innerHTML = "<p>Không có kết quả.</p>";
        }
      } catch (error) {
        console.error("Lỗi:", error);
        document.getElementById("output").innerHTML = `<p>Lỗi: ${error.message}</p>`;
      }
    }

    function animateOverlay() {
      const video = document.querySelector("video");
      if (!video) return;

      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");
      document.getElementById("output").appendChild(canvas);

      video.addEventListener("loadeddata", () => {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        let startTime = null;

        function draw(timestamp) {
          if (!startTime) startTime = timestamp;
          const elapsed = timestamp - startTime;

          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
          ctx.fillStyle = "rgba(0, 0, 0, 0.5)";
          ctx.fillRect(0, canvas.height - 50, canvas.width, 50);

          ctx.fillStyle = "white";
          ctx.font = "20px Arial";
          ctx.fillText("AI Video Ads", 20 + (elapsed / 50) % canvas.width, canvas.height - 20);

          if (!video.paused && !video.ended) {
            requestAnimationFrame(draw);
          }
        }

        video.play();
        requestAnimationFrame(draw);
      });
    }
  </script>
</body>
</html>
